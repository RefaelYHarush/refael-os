# איפה האתר כושל

מסמך זה מסכם **נקודות כישלון** בקוד וב־UX – מקומות שבהם המשתמש עלול לראות התנהגות לא צפויה, היעדר משוב, או שגיאות שלא מטופלות.

---

## 1. אימות והתחברות

### OAuth – ביטול או שגיאה בהתחברות גוגל
- **מה קורה:** כשהמשתמש חוזר מגוגל אחרי שביטל את ההרשאה (או שקרתה שגיאה), ה־URL מכיל `error=access_denied` (או דומה) ב־hash.
- **הבעיה:** ה־`AuthContext` מנקה את ה־hash מיד ולא קורא את פרטי השגיאה. המשתמש רואה שוב את מסך ההתחברות **בלי שום הודעה** שההתחברות בוטלה או נכשלה.
- **איפה:** `AuthContext.jsx` – ניקוי URL בלי לשמור/להציג את ה־error.
- **המלצה:** לקרוא את `window.location.hash` לפני הניקוי; אם יש `error=` – להעביר הודעה ל־AuthView (למשל דרך state או query) ולהציג: "ההתחברות עם גוגל בוטלה" / "אירעה שגיאה בהתחברות".

---

## 2. יומן (Calendar)

### טעינת רשימת היומנים – שגיאות לא מוצגות
- **מה קורה:** `fetchCalendarList` מחזיר `{ calendars, error }`. ב־CalendarView פונקציית `loadCalendars` משתמשת רק ב־`calendars` ומתעלמת מ־`error`.
- **תוצאה:** אם יש שגיאה (פג תוקף טוקן, אין הרשאה, רשת), המשתמש רואה רשימת יומנים ריקה **בלי הודעה**.
- **איפה:** `CalendarView.jsx` שורות 68–74 – חסר `setCalendarsError` או הצגת `error` כמו ב־`loadEvents`.
- **המלצה:** לטפל ב־`error` שמוחזר מ־`fetchCalendarList` ולהציג הודעת שגיאה (בדומה ל־`eventsError`).

### שמירת פרופיל יומן (קישור embed, יומן נבחר) – כישלון שקט
- **מה קורה:** כששמירת `calendarEmbedUrl` / `selectedCalendarId` ל־Supabase נכשלת, הקוד רק עושה `console.warn` **בלי** `setSyncError`.
- **תוצאה:** המשתמש לא יודע שההגדרות לא נשמרו בענן.
- **איפה:** `AppContext.jsx` – ה־useEffect של `saveCalendarProfile` קורא ל־`onError` עם רק `console.warn`, בלי `setSyncError('...')`.
- **המלצה:** להוסיף `setSyncError('שגיאה בשמירת הגדרות היומן – נשמר מקומית')` (או דומה) ב־onError של saveCalendarProfile.

---

## 3. סנכרון ונתונים

### טעינה ראשונית – רק אזהרה אחת
- **מה קורה:** אם `loadAll` נכשל (Supabase down, רשת), מוצגת הודעת `syncError`: "שגיאה בטעינת הנתונים – מוצגים נתונים מקומיים". זה טוב.
- **חולשה:** ההודעה מופיעה ב־Layout וניתן לסגור אותה; אם המשתמש סוגר ולא זוכר – הוא עלול לחשוב שהכל מסונכרן. אין אינדיקציה מתמשכת ש"אין חיבור ל־Supabase" (למשל אייקון/טקסט קבוע).

### שמירה – אותה הודעה לכולם
- **מה קורה:** כל כישלון שמירה (trades, tasks, vision, וכו') מעלה את אותה `syncError` גנרית. אם כמה דברים נכשלים ברצף, המשתמש רואה רק הודעה אחת כללית.
- **הערה:** לא "באג" אלא שיפור אפשרי – הודעות יותר ספציפיות ("שגיאה בסנכרון המסחר" וכו') או רשימת שדות שנכשלו.

---

## 4. דפים ותצוגות

### איפוס סיסמה – קישור ללא hash
- **מה קורה:** דף איפוס סיסמה בודק `type=recovery` ב־hash. אם המשתמש נכנס ל־`/reset-password` בלי hash (קישור ישן, דפדפן שחתך את ה־hash), הוא רואה "הקישור לא תקף או שפג תוקפו" – וזה נכון.
- **חולשה אפשרית:** חלק מהמיילים של איפוס שולחים קישור עם query params ולא hash. Supabase בדרך כלל משתמש ב־hash; אם בעתיד יגיע קישור עם params, ייתכן ש־`isRecovery` יישאר false. כדאי לתעד שתמיכה רק ב־hash.

### SaaS – גרירה (drag & drop)
- **מה קורה:** ב־`handleDrop` ב־SaasView יש `try/catch` שסוגר בשקט (`catch (_) {}`). אם `JSON.parse` נכשל או ש־`updateSaasProject` זורק, המשתמש לא רואה שום משוב.
- **איפה:** `SaasView.jsx` שורות 35–39.
- **המלצה:** להציג הודעת שגיאה מקומית (toast או טקסט) במקרה של כישלון.

### Relationships – formatDate
- **מה קורה:** `formatDate` עוטף ב־try/catch ומחזיר את המחרוזת המקורית בשגיאה. זה סביר ולא "כישלון" משתמש; רק אם יש נתון מקולקל המשתמש עלול לראות תאריך לא מעוצב.

---

## 5. משימות גוגל (Google Tasks)

- **מה קורה:** ב־GoogleTasksContext יש טיפול ב־error ו־loading; GoogleTasksCard מציגה `error` למשתמש. כישלונות טעינה/הוספה/עדכון/מחיקה מחזירים הודעות בעברית.
- **חולשה:** אם אין טוקן (משתמש לא התחבר עם גוגל או ביטל Tasks), המצב "אין רשימות" מוצג – אבל לא תמיד ברור שצריך לאשר גישה ל־Google Tasks בהתחברות. אפשר לשפר את הטקסט/העזרה.

---

## 6. נגישות ו־UX קלים

- **גרף 7 ימים ריק:** כשאין עסקאות ב־7 ימים אחרונים – הגרף ריק. מומלץ הודעה: "אין נתונים ל־7 הימים האחרונים" (כבר מופיע ב־AUDIT_REPORT).
- **כפתורים ללא פעולה:** לפי AUDIT_REPORT – כפתור "פרויקט חדש" ב־SaaS ו"פרטי עסקה" במסחר – אם עדיין לא מחוברים ל־handlers, לחיצה "לא עושה כלום" נתפסת ככישלון.

---

## סיכום לפי עדיפות

| עדיפות | נושא | איפה | תיקון מוצע |
|--------|------|------|------------|
| **גבוהה** | OAuth – הודעת שגיאה/ביטול אחרי חזרה מגוגל | AuthContext + AuthView | לקרוא error מה־URL ולהציג במסך ההתחברות |
| **גבוהה** | רשימת יומנים – שגיאות לא מוצגות | CalendarView loadCalendars | להציג calendarsError כמו eventsError |
| **בינונית** | שמירת פרופיל יומן – כישלון שקט | AppContext saveCalendarProfile | להוסיף setSyncError ב־onError |
| **בינונית** | SaaS גרירה – כישלון שקט | SaasView handleDrop | להציג הודעת שגיאה במקום catch ריק |
| **נמוכה** | אינדיקציה מתמשכת ל"ללא סנכרון" | Layout / AppContext | אייקון או טקסט כשהסנכרון נכשל |
| **נמוכה** | הודעה בגרף ריק (7 ימים) | DashboardView | "אין נתונים ל־7 הימים האחרונים" |

---

*מסמך זה מתבסס על סריקת הקוד ב־refael-os; מומלץ לעדכן אחרי כל שינוי משמעותי.*
